<template>
    <div>
        <el-form :model="formData" inline label-width="100px" label-position="left">
            <el-row>
                <mapArea ref="area"
                          title="区域位置"
                          @select-change="selectChange"
                          curNum="0">
                </mapArea>
            </el-row>
            <el-row>
                <el-form-item label="老人状况">
                    <el-radio-group v-model="formData.type" @change="getMapData">
                        <el-radio v-for="(item,index) in ['全部','高龄','独居','空巢','失独']"
                                     :key="index"
                                     :label="index">{{item}}</el-radio>
                    </el-radio-group>
                </el-form-item>
            </el-row>
        </el-form>
        <el-row>
            <div id="container" v-loading.body="loading"></div>
        </el-row>
    </div>
</template>
<script>
    import mapArea from '../../components/mapArea.vue';
    export default {
        data() {
            return {
                formData: {
                    //老人状态
                    type: "",
                    //省
                    province: "",
                    //市
                    city: "",
                    //区
                    zone: "",
                    //街道
                    street: ""
                },
                center: "",
                list: [],
                loading: false
            };
        },
        async created(){

        },
        mounted: function(){
            this.getMapData();
        },
        components: {
            mapArea
        },
        methods: {
            //请求mapData
            async getMapData(){
                try {
                    let data = {};
                    this.loading = true;
                    if(this.formData.type === 0) {
                        for(let k in this.formData){
                            data[k] = this.formData[k];
                            data.type = "";
                        }
                    }else{
                        data = this.formData;
                    };
                    let { center,list } = await  this.$http.post('/user/position',data);
                    this.center = center.split(",");
                    list.forEach(v=>v.position = v.position.split(","));
                    this.list = list;
                    this.drowMap();
                } catch (e) {
                    console.log(e);
                }
            },
            drowMap(){
                let map = new AMap.Map('container', {
                    resizeEnable: true,
                    zoom:11,
                    center: this.center
                });

                for(let i=0;i<this.list.length;i++){
                    let marker = new AMap.Marker({
                        position: this.list[i].position,
                        title: this.list[i].title + ": " +this.list[i].userNum
                    });
                    marker.setMap(map);
//                    marker.setLabel({//label默认蓝框白底左上角显示，样式className为：amap-marker-label
//                        offset: new AMap.Pixel(20, 20),//修改label相对于maker的位置
//                        content: this.list[i].title + ": " +this.list[i].userNum
//                    });
                }

                map.plugin(["AMap.ToolBar"], function() {
                    map.addControl(new AMap.ToolBar());
                });

                let _this = this;
                map.on('complete', function() {
                    _this.loading = false;
                });
            },
            selectChange(argus){
                console.log(argus);
                this.formData.province = argus.provinceName;
                this.formData.city = argus.cityName;
                this.formData.zone = argus.areaName;
                this.formData.street = argus.streetName;
                //
                this.getMapData();

            }
        },
    };
</script>
<style lang="scss" scoped>
    #container{
        height: 700px;
        width: 90%;
        margin: 0 auto;
    }
</style>
